<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AUTO ESCOLA GUARDA DOS FERREIROS - CURSINHO</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            text-align: center;
        }
        .page-container {
            max-width: 800px;
            width: 100%;
            margin-bottom: 40px;
        }
        .video-block {
            background-color: #34495e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        h1 {
            color: #f1c40f;
            border-bottom: 2px solid #f1c40f;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        /* Estilos dos botões de navegação */
        .button-container {
            margin-bottom: 25px;
            border-bottom: 1px solid #4a6784;
            padding-bottom: 15px;
        }
        .course-button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .course-button.active {
            background-color: #f1c40f;
            color: #2c3e50;
        }
        .course-button:not(.active) {
            background-color: #5d7d9a;
            color: #ecf0f1;
        }
        /* Estilos de Timer/Expiração */
        #mensagemExpiracao {
            display: none; 
            color: #e74c3c;
            font-size: 1.5em;
            margin-top: 20px;
        }
        .alerta-restante {
            background-color: #f39c12; 
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        /* Classes de Controle de Visibilidade */
        .hidden {
            display: none;
        }
        .content-hidden {
            display: none;
        }
        #instructionMessage {
            margin-top: 50px;
            background-color: #e74c3c;
            padding: 20px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    
    <div class="page-container hidden" id="instructionMessage">
        <p>Você precisa registrar sua presença para acessar o conteúdo do curso.</p>
        <button onclick="window.location.href='presenca.html'" 
                style="padding: 10px 20px; background-color: #f1c40f; color: #2c3e50; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
            Registrar Presença
        </button>
        <p style="font-size: 0.8em; margin-top: 20px; color: #f1c40f;" id="bypassMessage"></p>
    </div>

    <div class="page-container content-hidden" id="courseContent">
        
        <div class="button-container">
            <button class="course-button" data-course-id="course1" onclick="showCourse('course1')">Aula 1</button>
            <button class="course-button" data-course-id="course2" onclick="showCourse('course2')">Aula 2</button>
            </div>

        <div id="course1" class="video-block hidden" data-storage-key="acesso_curso1">
            <h1 id="title1">AULA 01: SINALIZAÇÃO</h1>
            
            <div id="areaTimer1">
                <p class="alerta-restante" id="tempoRestanteMensagem1">O vídeo será removido...</p>
                
                <iframe 
                    src="https://player.vimeo.com/video/1140876472?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" 
                    width="100%" 
                    height="450" 
                    frameborder="0" 
                    allow="autoplay; fullscreen; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
            <div id="mensagemExpiracao1" class="hidden">
                <p><strong>Tempo esgotado!</strong> O acesso a esta aula expirou.</p>
            </div>
        </div>

        <div id="course2" class="video-block hidden" data-storage-key="acesso_curso2">
            <h1 id="title2">AULA 02: SINALIZAÇÃO</h1>
            
            <div id="areaTimer2">
                <p class="alerta-restante" id="tempoRestanteMensagem2">O vídeo será removido...</p>
                
                <iframe 
                    src="https://player.vimeo.com/video/1140903162?badge=0&amp;autopause=0&amp;player_id=0&amp;app_id=58479" 
                    width="100%" 
                    height="450" 
                    frameborder="0" 
                    allow="autoplay; fullscreen; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            </div>
            <div id="mensagemExpiracao2" class="hidden">
                <p><strong>Tempo esgotado!</strong> O acesso a esta aula expirou.</p>
            </div>
        </div>

    </div>

    <script>
        // === CONFIGURAÇÃO GLOBAL ===
        const TEMPO_LIMITE_SEGUNDOS = 24 * 60 * 60 * 1000; // 5 minutos (Ajuste para o timer dos vídeos)
        const TEMPO_LIMITE_MS = 24 * 60 * 60 * 1000;
        const LIMITE_PRESENCA_MS = 24 * 60 * 60 * 1000; // 24h para o registro de presença (diário)
        const LOCK_DELAY_COURSES_MS = 24 * 60 * 60 * 1000; // NOVO: 24h de atraso entre cursos
        const CHAVE_PRESENCA = 'lastPresenceTime'; 
        
        let intervaloContador = null;

        // --- Lógica de Parâmetros ---
        const urlParams = new URLSearchParams(window.location.search);
        const isBypass = urlParams.get('bypass') === 'true'; 
        const isPresenceBypass = urlParams.get('presencabypass') === 'true'; 
        const isClear = urlParams.get('clear') === 'true';
        const isPresenceSuccess = urlParams.get('presenca') === 'true'; 
        
        const pad = (num) => String(num).padStart(2, '0');

        // --- 1. FUNÇÃO DE CONTROLE DE PRESENÇA (MOSTRA/ESCONDE CONTEÚDO) ---
        function checkPresence() {
            const courseContent = document.getElementById('courseContent');
            const instructionMessage = document.getElementById('instructionMessage');
            const bypassMessage = document.getElementById('bypassMessage');
            
            if (isPresenceSuccess) {
                localStorage.setItem(CHAVE_PRESENCA, Date.now());
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState(null, null, cleanUrl);
            }
            
            if (isPresenceBypass) {
                courseContent.classList.remove('content-hidden'); 
                instructionMessage.classList.add('hidden');
                bypassMessage.innerHTML = "MODO BYPASS DE PRESENÇA ATIVO. Acesso liberado.";
                return true; 
            }

            const lastTime = parseInt(localStorage.getItem(CHAVE_PRESENCA));
            const currentTime = Date.now();
            
            if (isNaN(lastTime) || (currentTime - lastTime) >= LIMITE_PRESENCA_MS) {
                courseContent.classList.add('content-hidden'); 
                instructionMessage.classList.remove('hidden'); 
                bypassMessage.innerHTML = "";
                return false; 
            } else {
                courseContent.classList.remove('content-hidden'); 
                instructionMessage.classList.add('hidden'); 
                bypassMessage.innerHTML = "";
                return true; 
            }
        }
        
        // --- 2. FUNÇÃO PRINCIPAL DE EXPIRAÇÃO DO VÍDEO ---
        function initializeTimer(courseId, storageKey) {
            // ... (Lógica do timer de 5 minutos permanece a mesma) ...
            if (intervaloContador) {
                clearInterval(intervaloContador);
            }
            
            const areaDoVideo = document.getElementById('areaTimer' + courseId.slice(-1));
            const mensagemExp = document.getElementById('mensagemExpiracao' + courseId.slice(-1));
            const mensagemTempoRestante = document.getElementById('tempoRestanteMensagem' + courseId.slice(-1));
            
            if (isBypass) {
                areaDoVideo.classList.remove('hidden');
                mensagemExp.classList.add('hidden');
                mensagemTempoRestante.innerHTML = "MODO TESTE ATIVADO (Bypass de Vídeo). O vídeo não expirará.";
                return; 
            }
            
            let inicioVisualizacao = parseInt(localStorage.getItem(storageKey));
            const tempoAtual = Date.now();

            if (isNaN(inicioVisualizacao)) {
                // ESTE É O MOMENTO EM QUE O CURSO FOI VISTO PELA PRIMEIRA VEZ
                inicioVisualizacao = tempoAtual;
                localStorage.setItem(storageKey, inicioVisualizacao);
            }

            const tempoDecorrido = tempoAtual - inicioVisualizacao;

            if (tempoDecorrido >= TEMPO_LIMITE_MS) {
                areaDoVideo.classList.add('hidden');
                mensagemExp.classList.remove('hidden');
            } else {
                areaDoVideo.classList.remove('hidden');
                mensagemExp.classList.add('hidden');

                intervaloContador = setInterval(function() {
                    const agora = Date.now();
                    const decorrido = agora - inicioVisualizacao;
                    let restanteMS = TEMPO_LIMITE_MS - decorrido;
                    
                    if (restanteMS <= 0) {
                        areaDoVideo.classList.add('hidden');
                        mensagemExp.classList.remove('hidden');
                        clearInterval(intervaloContador);
                    } else {
                        let totalSeconds = Math.floor(restanteMS / 1000);
                        const hours = Math.floor(totalSeconds / 3600);
                        totalSeconds %= 3600;
                        const minutes = Math.floor(totalSeconds / 60);
                        const seconds = totalSeconds % 60;
                        
                        const timeFormat = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

                        mensagemTempoRestante.innerHTML = `Disponível por: ${timeFormat}`; 
                    }
                }, 1000);
            }
        }

        // --- 3. FUNÇÃO DE NAVEGAÇÃO ENTRE AULAS (AGORA COM CHECAGEM DE 24H SEQUENCIAL) ---
        function showCourse(courseId) {
            const allCourses = document.querySelectorAll('.video-block');
            const allButtons = document.querySelectorAll('.course-button');
            const selectedCourse = document.getElementById(courseId);
            const storageKey = selectedCourse.getAttribute('data-storage-key');
            const courseNumber = parseInt(courseId.slice(-1));
            
            // ----------------------------------------------------
            // LÓGICA DE LIBERAÇÃO SEQUENCIAL (24H DE ATRASO)
            // ----------------------------------------------------
            
            if (courseNumber > 1) {
                const previousCourseNumber = courseNumber - 1;
                const previousStorageKey = `acesso_curso${previousCourseNumber}`;
                const previousCourseStartTime = parseInt(localStorage.getItem(previousStorageKey));

                // 1. Checa se o curso anterior foi iniciado
                if (isNaN(previousCourseStartTime)) {
                    alert(`Você precisa iniciar a Aula ${previousCourseNumber} primeiro para liberar a Aula ${courseNumber}.`);
                    return;
                }

                // 2. Calcula o tempo de liberação e checa se já passou
                const unlockTime = previousCourseStartTime + LOCK_DELAY_COURSES_MS;
                const currentTime = Date.now();

                if (currentTime < unlockTime) {
                    const timeRemaining = unlockTime - currentTime;
                    let totalSeconds = Math.floor(timeRemaining / 1000);
                    
                    const hours = Math.floor(totalSeconds / 3600);
                    totalSeconds %= 3600;
                    const minutes = Math.floor(totalSeconds / 60);
                    const seconds = totalSeconds % 60;
                    
                    const timeFormat = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

                    alert(`A Aula ${courseNumber} só será liberada 24 horas após o início da Aula ${previousCourseNumber}.\nTempo restante: ${timeFormat}`);
                    
                    return; // Bloqueia o acesso se 24h não passaram
                }
            }

            // ----------------------------------------------------
            // LÓGICA NORMAL DE EXIBIÇÃO
            // ----------------------------------------------------

            allCourses.forEach(course => course.classList.add('hidden'));
            if (intervaloContador) { clearInterval(intervaloContador); }

            selectedCourse.classList.remove('hidden');

            allButtons.forEach(button => {
                button.classList.remove('active');
                if (button.getAttribute('data-course-id') === courseId) {
                    button.classList.add('active');
                }
            });

            initializeTimer(courseId, storageKey);
        }

        // --- 4. INICIALIZAÇÃO DA PÁGINA ---
        document.addEventListener('DOMContentLoaded', function() {
            // Lógica de Limpeza Geral (Timer de Vídeo e Presença)
            if (isClear) {
                localStorage.removeItem('acesso_curso1');
                localStorage.removeItem('acesso_curso2');
                // Adicione mais remoções aqui se tiver mais cursos (ex: 'acesso_curso3')
                localStorage.removeItem(CHAVE_PRESENCA); 
                
                console.log("LocalStorage de vídeos e presença limpo. Redirecionando...");
                window.location.href = window.location.origin + window.location.pathname; 
                return; 
            }

            const isAccessValid = checkPresence();

            if (isAccessValid) {
                showCourse('course1'); 
            }
        });
    </script>
</body>
</html>
